<!DOCTYPE HTML>
<!--
  Dimension by HTML5 UP
  html5up.net | @ajlkn
  Free for personal & commercial use under CCA 3.0 (html5up.net/license)
-->
<html>
  <head>
    <title>Analytics Engineer | Justynn Hammond</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="description" content="Justynn Hammond ‚Äî Decision Support & Data Science. Legacy-to-modern data platforms, Python/SQL/Power BI, reconciliation & dashboards." />
    <link rel="stylesheet" href="assets/css/main.css" />
    <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
    <style>
      /* minor fixes for centered CTAs and tidy resume */
      .cta { text-align:center; margin-top:1.5rem; }
      .cta .button { margin:.4rem; min-width: 200px; }
      #resume .button { min-width: 220px; }
      .pdf-embed { margin-top:1rem; }
      .pdf-fallback { text-align:center; opacity:.85; margin-top:.5rem; }

      /* [CSS-1] Projects grid */
      .projects-grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
      .project { border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; }
      .project img { width: 100%; height: 160px; object-fit: cover; border-radius: 8px; }
      .tags { display: flex; flex-wrap: wrap; gap: .4rem; margin: .5rem 0; }
      .tag { font-size: .8rem; padding: .2rem .5rem; border: 1px solid #e5e7eb; border-radius: 999px; }

        /* ===== Resume mask (locks the inline PDF until recruiter gate unlocks) ===== */
        #resume-pdf-wrap{
          position: relative;
          margin-top: 1rem;
        }

        #resume-pdf-iframe{
          width: 100%;
          height: 800px;
          display: block;
          border: 0;
          border-radius: 12px;
        }

        /* Blur + disable interaction while locked */
        #resume-pdf-wrap.is-locked #resume-pdf-iframe{
          filter: blur(6px);
          opacity: .75;
          pointer-events: none;
          user-select: none;
        }

        /* Transparent overlay that sits above the iframe while locked */
        #resume-mask-overlay{
          display: none;
          position: absolute;
          inset: 0;
          border-radius: 12px;
          background: rgba(0,0,0,.10); /* transparent mask */
          border: 1px solid rgba(255,255,255,.18);
          cursor: pointer;
        }

        #resume-pdf-wrap.is-locked #resume-mask-overlay{
          display: block;
        }

        #resume-mask-overlay .mask-card{
          position: absolute;
          left: 50%;
          top: 50%;
          transform: translate(-50%,-50%);
          max-width: 520px;
          width: calc(100% - 2rem);
          background: rgba(0,0,0,.60);
          border: 1px solid rgba(255,255,255,.22);
          border-radius: 14px;
          padding: 14px 16px;
          text-align: center;
        }
        #resume-mask-overlay .mask-card .sub{
          opacity: .9;
          margin-top: .35rem;
        }

        /* ===== Recruiter Journey (A) ===== */
        #recruiter-journey {
          margin-top: 1rem;
        }
        #recruiter-journey .row {
          display: flex;
          gap: .6rem;
          flex-wrap: wrap;
          align-items: center;
        }
        #recruiter-journey .muted { opacity: .9; }
        #recruiter-journey ul {
          margin: .6rem 0 0 1.1rem;
        }
        #recruiter-journey li { margin: .25rem 0; }

        /* ===== Reward Toast + Trophy Drawer (B) ===== */
        #reward-toast {
          position: fixed;
          right: 16px;
          bottom: 16px;
          z-index: 10000;
          display: none;
          max-width: 340px;
          background: rgba(0,0,0,.78);
          border: 1px solid rgba(255,255,255,.22);
          border-radius: 14px;
          padding: 12px 14px;
          box-shadow: 0 14px 38px rgba(0,0,0,.35);
        }
        #reward-toast .sub { opacity: .9; margin-top: .25rem; }

        #trophy-fab {
          position: fixed;
          right: 16px;
          bottom: 74px;
          z-index: 10000;
          display: none;
          width: 46px;
          height: 46px;
          border-radius: 999px;
          border: 1px solid rgba(255,255,255,.25);
          background: rgba(0,0,0,.65);
          color: inherit;
          cursor: pointer;
          box-shadow: 0 14px 38px rgba(0,0,0,.35);
        }
        #trophy-fab:active { transform: scale(.97); }

        #trophy-drawer {
          position: fixed;
          right: 16px;
          bottom: 128px;
          z-index: 10000;
          width: min(420px, calc(100vw - 32px));
          max-height: 60vh;
          overflow: auto;
          display: none;
          background: rgba(0,0,0,.82);
          border: 1px solid rgba(255,255,255,.22);
          border-radius: 16px;
          padding: 14px 14px 10px 14px;
          box-shadow: 0 14px 38px rgba(0,0,0,.35);
        }
        #trophy-drawer h4 { margin: 0 0 .35rem 0; }
        #trophy-drawer .muted { opacity: .9; }
        #trophy-drawer ul { margin: .6rem 0 0 1.1rem; }
        #trophy-drawer li { margin: .25rem 0; }


      /* [CSS-2] Study hub */
      #study .bar { display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; margin-bottom:1rem; }
      #study input#study-search { flex:1; min-width:220px; }
      .tabs { display:flex; gap:.5rem; flex-wrap:wrap; }
      .tabs button { border:1px solid #e5e7eb; padding:.35rem .7rem; border-radius:999px; background:transparent; cursor:pointer; }
      .tabs button.active { border-width:2px; }
      .notes-grid { display:grid; gap:1rem; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); }
      .note { border:1px solid #e5e7eb; border-radius:12px; padding:12px 14px; }
      .note .meta { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem; opacity:.9; }
      .chip { font-size:.8rem; padding:.15rem .5rem; border:1px solid #e5e7eb; border-radius:999px; }
      .warn { color:#c0392b; }

      /* [STYLE] Study polish (adds contrast + ‚Äúapp‚Äù feel without breaking Dimension theme) */
      #study-results { min-height: 220px; }

      #study-status {
        background: rgba(0,0,0,.35);
        border: 1px solid rgba(255,255,255,.22);
        border-radius: 12px;
        padding: .6rem .9rem;
        margin: 0 0 1rem 0;
      }

      #study .tabs button.active {
        background: rgba(255,255,255,.10);
        box-shadow: 0 0 0 2px rgba(255,255,255,.75), 0 0 18px rgba(255,255,255,.25);
      }

      #study .tabs button:hover {
        background: rgba(255,255,255,.06);
      }

      .note {
        background: rgba(0,0,0,.35);
        border: 1px solid rgba(255,255,255,.22);
        box-shadow: 0 10px 30px rgba(0,0,0,.25);
        transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      }

      .note:hover {
        transform: translateY(-2px);
        border-color: rgba(255,255,255,.45);
        box-shadow: 0 14px 38px rgba(0,0,0,.35);
      }

      .chip {
        border-color: rgba(255,255,255,.28);
        background: rgba(255,255,255,.06);
      }

      /* [ANIM-1] Modal + card animations */
        #study-modal { animation: fadeIn .25s ease; }
        #study-modal-card { animation: slideUp .3s cubic-bezier(.2,.8,.2,1); }

        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
        @keyframes slideUp { from {transform:translateY(30px) scale(.98);} to {transform:translateY(0) scale(1);} }

        /* [ANIM-2] Button press feedback */
        button:active { transform: scale(0.96); }

        /* [ANIM-3] Cards feel more ‚Äúapp-like‚Äù */
        .note, .project {
          transition: transform .18s cubic-bezier(.2,.8,.2,1),
                      box-shadow .18s ease,
                      border-color .18s ease;
}
        .note:hover { transform: translateY(-4px) scale(1.01); }

        /* [UI] Progress bar */
        .progress-bar {
          height: 6px;
          background: rgba(255,255,255,.15);
          border-radius: 999px;
          overflow: hidden;
        }
        .progress-fill {
          height: 100%;
          border-radius: 999px;
          transition: width .35s ease;
          background: linear-gradient(90deg, rgba(102,204,255,1), rgba(153,255,255,1));
        }

          /* [ANIM] Smooth entrance for game cards */
          #lab-card, #pipeline-card, #fantasy-card, #trade-card {
            animation: slideUp .25s cubic-bezier(.2,.8,.2,1);
          }
          @keyframes slideUp {
            from { transform: translateY(16px); opacity: .0; }
            to { transform: translateY(0); opacity: 1; }
          }

          /* [ANIM] Buttons feel clickable */
          #labs-tabs button, #labs-difficulty button {
            transition: transform .12s ease, background .2s ease, box-shadow .2s ease;
          }
          #labs-tabs button:active, #labs-difficulty button:active {
            transform: scale(.97);
          }

          /* =========================
            LABS UI (centered + clean)
            ========================= */

            #labs .bar { display:flex; flex-direction:column; gap:.8rem; margin-bottom: 1rem; }

            .labs-row {
              display:flex;
              flex-wrap:wrap;
              justify-content:center;
              gap:.65rem;
            }
            
            .labs-row.small button {
              padding: .25rem .6rem;
              font-size: .85rem;
              opacity: .95;
            }
            
            #labs-meta {
              display:flex;
              flex-wrap:wrap;
              justify-content:center;
              gap:.6rem;
              margin:.25rem 0 .75rem 0;
            }
            
            #labs-meta .chip { background: rgba(255,255,255,.06); }
            
            #labs-launcher { margin-top: .5rem; }
            
            #labs-cardwrap { display:none; margin-top: 1rem; }
            
            .labs-card {
              background: rgba(0,0,0,.35);
              border: 1px solid rgba(255,255,255,.22);
              border-radius: 14px;
              padding: 16px;
              box-shadow: 0 14px 38px rgba(0,0,0,.35);
            }
            
            .labs-card h3 { margin: 0 0 .3rem 0; }
            .labs-card .sub { opacity:.9; margin-bottom: .75rem; }
            .labs-card pre {
              max-height: 280px;
              overflow:auto;
              white-space:pre-wrap;
              border:1px solid rgba(255,255,255,.18);
              border-radius:12px;
              padding:12px;
              background: rgba(0,0,0,.25);
            }
            
            .labs-actions { display:flex; flex-direction:column; gap:.6rem; margin-top:.75rem; }
            #labs-actions .button {
                width: 100%;
                max-width: 100%;
                white-space: normal;          /* allow wrapping */
                word-break: break-word;       /* break long phrases */
                overflow-wrap: anywhere;
                text-align: left;
                line-height: 1.35;
                padding: 0.75rem 1rem;
                box-sizing: border-box;
              }

              /* Prevent card overflow */
              #labs-cardwrap,
              .labs-card {
                overflow-x: hidden;
              }

              /* Ensure action column stays contained */
              .labs-actions {
                width: 100%;
              }
            
            .labs-topbar {
              display:flex;
              justify-content:space-between;
              align-items:center;
              gap: .75rem;
              flex-wrap:wrap;
              margin-bottom:.75rem;
            }
            
            .labs-topbar .right { display:flex; gap:.5rem; flex-wrap:wrap; justify-content:flex-end; }

    </style>
  </head>
  <body class="is-preload">

    <!-- Wrapper -->
    <div id="wrapper">

      <!-- Header -->
      <header id="header">
        <div class="logo"><span class="icon fa-gem"></span></div>
        <div class="content">
          <div class="inner">
            <h1>Justynn Hammond's Digital Portfolio</h1>
            <p>Analytics Engineer with experience in government modernization, logistics, and data-driven decision support.</p>
          </div>
        </div>
        <nav>
          <ul>
            <li><a href="#intro">Intro</a></li>
            <li><a href="#work">Work</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#resume">Resume</a></li>
            <li><a href="#study">Study</a></li>
            <li><a href="#labs">Game Labs</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </nav>
      </header>

      <!-- Main -->
      <div id="main">

        <!-- Intro -->
        <article id="intro">
          <h2 class="major">Intro</h2>
          <span class="image main">
            <!-- put your hero image here -->
            <img src="images/pic01.jpg" alt="Intro‚Äîdashboard and data pipeline overview" />
          </span>
          <p>I modernize legacy systems and turn messy, high-stakes data into real-time, decision-ready insights using Python, SQL, and Power BI.</p>
          <ul class="bullets">
            <li>Led FLAIR ‚Üí Florida PALM data modernization (pipelines, reconciliation, analytics).</li>
            <li>Built SQL/Python integrations &amp; role-based dashboards for TRP19‚Äì31 (DOC modernization).</li>
            <li>Designed secure ingestion frameworks that reduced manual work from days to hours.</li>
          </ul>
          <p class="cta">
            <a href="#work" class="button">See Projects</a>
            <a href="#work" class="button outline">Work History</a>
            <a href="#about" class="button outline">About</a>
            <a href="#resume" class="button">Download Resume</a>
          </p>
        </article>

        <!-- Work -->
        <article id="work">
          <h2 class="major">Work</h2>
          <span class="image main"><img src="images/pic02.jpg" alt="Work‚Äîproject showcase" /></span>
          <p>Recent roles (separate, sequential):</p>
          <ul>
            <li><strong>Senior Decision Support Specialist ‚Äî OAG:</strong> FLAIR ‚Üí Florida PALM modernization (ingestion, reconciliation, analytics).</li>
            <li><strong>Data Scientist ‚Äî GTG (TRP19‚Äì31):</strong> SQL/Python integrations, audit workflow automation, role-based dashboards.</li>
            <li><strong>Lead Analytics Consultant ‚Äî FDEM:</strong> AI-assisted dashboards &amp; secure ingestion for state reporting.</li>
            <li><strong>CEO ‚Äî 6ix Bio:</strong> Pyrolysis research &amp; hemp composites for industrial applications.</li>
            <li><strong>Rail Data Manager ‚Äî OmniTRAX:</strong> Rail logistics data management &amp; reporting optimization.</li>
          </ul>

          <hr />

          <h3>Projects</h3>
          <!-- dynamic projects from Supabase -->
          <div id="projects-list" class="projects-grid"></div>
          <p>Sample projects; more on my <a href="https://github.com/jhamm2315/" target="_blank" rel="noopener">GitHub</a>.</p>
          <ul class="alt">
            <li><a href="https://github.com/jhamm2315/project-1-" target="_blank" rel="noopener">Air Quality &amp; Pollution during COVID-19 ‚Äî analysis</a></li>
            <li><a href="https://github.com/jhamm2315/ETL" target="_blank" rel="noopener">ETL for Video Game Data ‚Äî extraction &amp; transforms</a></li>
            <li><a href="https://github.com/jhamm2315/Hammond-API-Challege-" target="_blank" rel="noopener">API Calls + Analysis ‚Äî integration</a></li>
            <li><a href="https://github.com/jhamm2315/Hammond-Python-Challenge" target="_blank" rel="noopener">Python Challenge ‚Äî data cleaning &amp; logic</a></li>
            <li><a href="https://github.com/jhamm2315/plotly_challenge" target="_blank" rel="noopener">Plotly ‚Äî interactive visualization</a></li>
            <li><a href="https://github.com/jhamm2315/Movie_Correlation" target="_blank" rel="noopener">Movie Data Cleaning ‚Äî correlation &amp; EDA</a></li>
          </ul>
        </article>

        <!-- About -->
        <article id="about">
          <h2 class="major">About</h2>
          <span class="image main"><img src="images/pic03.jpg" alt="About Justynn Hammond" /></span>
          <p>I‚Äôm a results-driven data professional focused on modernizing government systems and shipping analytics leaders actually use. I specialize in bridging policy and operations with technical implementation‚Äîdata pipelines, reconciliation frameworks, and BI dashboards‚Äîto deliver measurable impact.</p>
          <p><strong>Recent roles (separate, sequential):</strong> Senior Decision Support Specialist (OAG) ‚Üí Data Scientist (GTG). Earlier: Lead Analytics Consultant (FDEM), CEO (6ix Bio), Rail Data Manager (OmniTRAX).</p>
          <p><strong>Strengths:</strong> Python, SQL, Power BI, ETL, Data Quality, Reconciliation, Audit Workflow Automation, Git.</p>
        </article>

        <!-- Resume -->
        <article id="resume">
          <h2 class="major">Resume</h2>

          <div id="resume-gate" class="labs-card" style="margin-top:1rem;">
            <h3 style="margin:0 0 .25rem 0;">Resume download</h3>
            <p class="sub" style="margin:0 0 .75rem 0;opacity:.9;">
             Before sharing my resume, I ask recruiters three quick alignment questions.
This ensures we‚Äôre aligned on role scope, expectations, and timeline before either of us invests more time.
            </p>

            <!-- microcopy: precise timer -->
            <p id="resume-timer-line" style="margin:.35rem 0 .75rem 0;opacity:.85;">
              Takes ~<strong id="resume-timer-ms">37.5869</strong> seconds.
            </p>

            <div style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;">
              <button id="resume-unlock-btn" class="button" type="button">Recruiter: Check Alignment</button>

              <!-- This is the REAL download link. Starts disabled until unlocked. -->
              <a id="resume-download-link"
                href="assets/resume/Justynn_Hammond_Resume_2026.pdf"
                class="button primary"
                download
                aria-disabled="true"
                style="pointer-events:none;opacity:.55;">
                Download PDF
              </a>

              <span class="chip" id="resume-dl-count">Downloads: ‚Äî</span>
            </div>

            <p id="resume-gate-msg" class="warn" style="display:none;margin:.6rem 0 0 0;"></p>
          </div>

          <!-- Modal (can live anywhere inside #resume, usually right after the block above) -->
          <div id="resume-gate-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:9999;padding:4rem 1rem;">
            <div style="max-width:820px;margin:0 auto;background:rgba(0,0,0,.78);border:1px solid rgba(255,255,255,.22);border-radius:14px;padding:18px;">
              <div style="display:flex;justify-content:space-between;gap:1rem;align-items:flex-start;">
                <div>
                  <h3 style="margin:0 0 .25rem 0;">Recruiter unlock</h3>
                  <div style="opacity:.9;">Answer 3 questions to unlock the resume download.</div>
                </div>
                <button id="resume-gate-close" class="button small" type="button">Close</button>
              </div>

              <div style="margin-top:1rem;">
                <div class="chip" id="resume-gate-progress">Step 1 of 3</div>
              </div>

              <div id="resume-gate-qwrap" style="margin-top:1rem;"></div>

              <div style="display:flex;gap:.5rem;justify-content:flex-end;flex-wrap:wrap;margin-top:1rem;">
                <button id="resume-gate-back" class="button small" type="button" style="display:none;">Back</button>
                <button id="resume-gate-next" class="button primary" type="button">Next</button>
              </div>

              <p id="resume-gate-err" class="warn" style="display:none;margin:.75rem 0 0 0;"></p>
            </div>
          </div>

          <!-- Inline PDF viewer (masked until unlocked) -->
          <div class="pdf-embed is-locked" id="resume-pdf-wrap">
            <iframe
              id="resume-pdf-iframe"
              src="assets/resume/Justynn_Hammond_Resume_2026.pdf#view=FitH"
              loading="lazy"
              title="Justynn Hammond Resume">
            </iframe>

            <!-- Overlay shown while locked -->
            <div id="resume-mask-overlay" role="button" tabindex="0" aria-label="Unlock resume">
              <div class="mask-card">
                <strong>Recruiter unlock required</strong>
                <div class="sub">Answer 3 quick questions to view + download the resume.</div>
                <div style="margin-top:.75rem;">
                  <span class="button small">Unlock now</span>
                </div>
              </div>
            </div>

            <p class="pdf-fallback">
              Can‚Äôt display PDFs inline.
              <a href="assets/resume/Justynn_Hammond_Resume_2026.pdf" target="_blank" rel="noopener">Open Resume</a>.
            </p>
          </div>
        </article>

        <!-- Study (locked) -->
        <article id="study">
          <h2 class="major">Study</h2>

          <!-- Locked view -->
          <div id="study-locked">
            <p>Sign in to unlock the Study hub (notes & cheat sheets).</p>
            <form id="study-signin" class="auth">
              <div class="fields">
                <div class="field half">
                  <label for="study-email">Email</label>
                  <input type="email" id="study-email" name="email" required />
                </div>
                <div class="field half">
                  <label for="study-password">Password</label>
                  <input type="password" id="study-password" name="password" required />
                </div>
              </div>
              <ul class="actions">
                <li><button class="primary" type="submit">Sign in</button></li>
              </ul>
              <p class="warn" id="study-auth-msg" style="display:none;"></p>
            </form>
          </div>

          <!-- Unlocked view -->
          <div id="study-unlocked" style="display:none">

            <div class="bar">
              <div class="tabs" id="study-tabs" aria-label="Study categories">
                <button data-cat="SQL" class="active">SQL</button>
                <button data-cat="Python">Python</button>
                <button data-cat="Power BI">Power BI</button>
                <button data-cat="Tableau">Tableau</button>
                <button data-cat="AWS">AWS</button>
                <button data-cat="Interviewing">Interviewing</button>
                <button data-cat="BA/PM">BA/PM</button>
                <button data-cat="Data Product">Data Product</button>
              </div>

              <!-- SQL subcategory tabs (ONLY shown when SQL is active) -->
              <div class="tabs" id="study-subtabs" aria-label="SQL subcategories" style="display:none;">
                <button data-sub="CTEs" class="active">CTEs</button>
                <button data-sub="Joins">Joins</button>
                <button data-sub="Aggregations">Aggregations</button>
                <button data-sub="Window">Window</button>
                <button data-sub="Indexing">Indexing</button>
              </div>

              <input id="study-search" type="search" placeholder="Search notes, tags, keywords‚Ä¶" />
              <button id="study-signout" class="button small" type="button">Sign out</button>
            </div>

            <!-- status banner is injected by JS right above results -->
            <div id="study-results" class="notes-grid" aria-live="polite"></div>
          </div>
        </article>

        <!-- Labs (gamified) -->
        <article id="labs">
          <h2 class="major">Labs</h2>
          <p>Quick games that prove real analytics engineering skills. Try the SQL quiz and see your score.</p>

          <div class="bar">
            <!-- Category (SQL vs Python) -->
            <div class="labs-row" id="labs-category">
              <button class="active" data-cat="SQL">SQL</button>
              <button data-cat="Python">Python</button>
            </div>
        
            <!-- Games (changes based on category) -->
            <div class="labs-row" id="labs-games" aria-label="Labs games"></div>
        
            <!-- Difficulty (smaller + separate) -->
            <div class="labs-row small" id="labs-difficulty" aria-label="Difficulty">
              <button class="active" data-diff="rookie">Rookie</button>
              <button data-diff="pro">Pro</button>
              <button data-diff="front_office">Front Office</button>
              <label style="display:flex;align-items:center;gap:.4rem;margin-left:.4rem;">
                <input type="checkbox" id="labs-helper" checked>
                <span style="opacity:.9;">Helper Mode</span>
              </label>
            </div>
        
            <!-- Meta -->
            <div id="labs-meta">
              <span class="chip">Score: <strong id="labs-score">0</strong></span>
              <span class="chip">Streak: <strong id="labs-streak">0</strong></span>
              <span class="chip">Badges: <strong id="labs-badges">‚Äî</strong></span>
              <span class="chip" id="labs-access">Access: <strong>Free</strong></span>
            </div>
          </div>
        
          <!-- Launcher message -->
          <div id="labs-launcher" class="labs-card">
            <h3>Select a game</h3>
            <p class="sub">Choose a game above. Only one game runs at a time. Your difficulty + helper mode apply across games.</p>
            <p style="opacity:.85;margin:0;">Tip: refresh the page to get a new randomized SQL question set.</p>
          </div>
        
          <!-- Single game card (only ONE shown) -->
          <div id="labs-cardwrap">
            <div class="labs-card">
              <div class="labs-topbar">
                <div>
                  <h3 id="labs-card-title">Game</h3>
                  <div class="sub" id="labs-card-sub"></div>
                </div>
                <div class="right">
                  <button class="button small" id="labs-back" type="button">Back</button>
                  <button class="button small" id="labs-next" type="button">Next</button>
                  <button class="button small" id="labs-reset" type="button">Reset</button>
                </div>
              </div>
        
              <div id="labs-helpertext" style="opacity:.95;margin:.25rem 0 .75rem 0;"></div>
        
              <pre id="labs-code"></pre>
        
              <div class="labs-actions" id="labs-actions"></div>
        
              <p id="labs-feedback" style="margin-top:.75rem;"></p>
        
              <div id="labs-paywall" class="warn" style="display:none;margin-top:.75rem;">
                Free limit reached for this difficulty. Sign in / become a member to keep playing.
              </div>
            </div>
          </div>
        </article>

        <!-- Contact -->
        <article id="contact">
          <h2 class="major">Contact</h2>
          <form method="post" action="#">
            <div class="fields">
              <div class="field half">
                <label for="name">Name</label>
                <input type="text" name="name" id="name" />
              </div>
              <div class="field half">
                <label for="email">Email</label>
                <input type="text" name="email" id="email" />
              </div>
              <div class="field">
                <label for="message">Message</label>
                <textarea name="message" id="message" rows="4"></textarea>
              </div>
            </div>
            <ul class="actions">
              <li><input type="submit" value="Send Message" class="primary" /></li>
              <li><input type="reset" value="Reset" /></li>
            </ul>
          </form>
          <ul class="icons">
            <li><a href="https://twitter.com" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
            <li><a href="https://facebook.com" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
            <li><a href="https://instagram.com" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
            <li><a href="https://github.com/jhamm2315" class="icon brands fa-github"><span class="label">GitHub</span></a></li>
          </ul>
        </article>

      </div><!-- /#main -->

      <!-- Footer -->
      <footer id="footer">
        <p class="copyright">&copy; 2025 OmniEdge Professionals LLC.</p>
      </footer>

    </div><!-- /#wrapper -->

    <!-- BG -->
    <div id="bg"></div>

    <!-- Reward Toast + Trophy Drawer (B) -->
      <div id="reward-toast" role="status" aria-live="polite"></div>

      <button id="trophy-fab" type="button" aria-label="Open rewards">üèÜ</button>

      <div id="trophy-drawer" aria-label="Unlocked rewards">
        <div style="display:flex;justify-content:space-between;gap:.75rem;align-items:flex-start;">
          <div>
            <h4>Unlocked Rewards</h4>
            <div class="muted">These unlock from the recruiter journey.</div>
          </div>
          <button id="trophy-close" class="button small" type="button">Close</button>
        </div>

        <ul id="trophy-rewards-list"></ul>
      </div>

    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>

    <!-- [JS-1] Projects from Supabase -->
    <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

      if (!window.__SUPABASE__) {
        window.__SUPABASE__ = createClient('https://uymuwikmssxdtbeocoyf.supabase.co', 'sb_publishable_ER4iXdw7aQRT25icZttTug_p3YJEPxW');
      }
      // supabase client available on window.__SUPABASE__

      async function loadProjects() {
        const list = document.getElementById('projects-list');
        if (!list) return;
        list.innerHTML = '<p>Loading projects‚Ä¶</p>'; 

        const { data, error } = await window.__SUPABASE__
          .from('projects')
          .select('id, slug, title, short_summary, tags, hero_image_url, repo_url, demo_url, featured, sort_order, created_at, published')
          .eq('published', true)
          .order('featured', { ascending: false })
          .order('sort_order', { ascending: true, nullsFirst: false })
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Supabase error:', error);
          list.innerHTML = '<p>Could not load projects right now.</p>';
          return;
        }

        if (!data || data.length === 0) {
          list.innerHTML = '<p>No projects published yet.</p>';
          return;
        }

        const staticList = document.querySelector('#work ul.alt');
        if (staticList) staticList.style.display = 'none';

        list.innerHTML = data.map(p => projectCard(p)).join('');
      }

      function projectCard(p) {
        const img = p.hero_image_url ? `<img alt="${escapeHtml(p.title)}" src="${p.hero_image_url}">` : '';
        const tags = Array.isArray(p.tags) ? p.tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('') : '';
        const repo = p.repo_url ? `<a href="${p.repo_url}" target="_blank" rel="noopener">Code</a>` : '';
        const demo = p.demo_url ? `<a href="${p.demo_url}" target="_blank" rel="noopener">Demo</a>` : '';
        return `
          <article class="project" id="project-${escapeHtml(p.slug)}">
            ${img}
            <h4>${escapeHtml(p.title)}</h4>
            <p>${escapeHtml(p.short_summary || '')}</p>
            <div class="tags">${tags}</div>
            <div class="links">${repo} ${demo}</div>
          </article>
        `;
      }

      function escapeHtml(str) {
        return String(str ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadProjects);
      } else {
        loadProjects();
      }
    </script>

    <!-- [JS-2] Study hub: Auth + tabs + search (FIXED + BACK-TO-RESULTS WORKING) -->
    <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

      if (!window.__SUPABASE__) {
        window.__SUPABASE__ = createClient('https://uymuwikmssxdtbeocoyf.supabase.co', 'sb_publishable_ER4iXdw7aQRT25icZttTug_p3YJEPxW');
      }
      // supabase client available on window.__SUPABASE__

      console.log('[Study] JS-2 loaded');

      // Elements
      const locked = document.getElementById('study-locked');
      const unlocked = document.getElementById('study-unlocked');
      const authMsg = document.getElementById('study-auth-msg');
      const signinForm = document.getElementById('study-signin');
      const signoutBtn = document.getElementById('study-signout');
      const tabs = document.getElementById('study-tabs');
      const subtabs = document.getElementById('study-subtabs');
      const searchInput = document.getElementById('study-search');
      const results = document.getElementById('study-results');

      // Prefill email (requested). Do NOT hardcode password.
      document.getElementById('study-email')?.setAttribute('value', 'jh.2315@outlook.com');

      // State
      let activeCategory = 'SQL';
      let activeSubcategory = null; // null = "All"

      // Helpers
      function escapeHtml(str) {
        return String(str ?? '').replace(/[&<>"']/g, m => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
        }[m]));
      }

      function debounce(fn, ms = 300) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }

      function isEmpty(str) {
        return !str || String(str).trim() === '';
      }

      // Ensure we're staying on the Study panel without triggering Dimension transitions
      function stayOnStudyPanel() {
        // history.replaceState updates the URL without triggering hash-change behavior
        if (location.hash !== '#study') {
          history.replaceState(null, '', '#study');
        }
      }

      // Scroll back to search/results area (this is your requested ‚ÄúBack‚Äù behavior)
      function goBackToStudyResults() {
        // IMPORTANT: force the Study panel WITHOUT triggering Dimension's hash transition
        history.replaceState(null, '', '#study');
      
        const searchBar = document.querySelector('#study .bar');
        const resultsEl = document.getElementById('study-results');
        const target = searchBar || resultsEl;
      
        // wait a tick so Dimension finishes any panel animation
        setTimeout(() => {
          target?.scrollIntoView({ behavior: 'smooth', block: 'start' });
          searchInput?.focus();
        }, 50);
      }

      // Status banner
      function ensureStudyStatusEl() {
        let el = document.getElementById('study-status');
        if (!el) {
          el = document.createElement('div');
          el.id = 'study-status';
          el.style.margin = '0 0 1rem 0';
          results?.parentNode?.insertBefore(el, results);
        }
        return el;
      }

      function setStudyStatus(msg) {
        const el = ensureStudyStatusEl();
        if (el) el.textContent = msg;
      }

      // Modal (single view)
      function ensureModal() {
        let modal = document.getElementById('study-modal');
        if (modal) return modal;

        modal = document.createElement('div');
        modal.id = 'study-modal';
        modal.style.display = 'none';
        modal.style.position = 'fixed';
        modal.style.inset = '0';
        modal.style.background = 'rgba(0,0,0,.65)';
        modal.style.zIndex = '9999';
        modal.style.padding = '4rem 1rem';

        modal.innerHTML = `
          <div id="study-modal-card" style="max-width:900px;margin:0 auto;background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.25);border-radius:14px;padding:18px;">
            <div style="display:flex;justify-content:space-between;gap:1rem;align-items:flex-start;">
              <div>
                <h3 id="study-modal-title" style="margin:0 0 .25rem 0;"></h3>
                <div id="study-modal-meta" style="opacity:.9;margin-bottom:.75rem;"></div>
              </div>
              <button id="study-modal-close" class="button small" type="button">Back</button>
            </div>

            <div style="display:flex;justify-content:flex-end;margin:.25rem 0 .75rem 0;">
              <button id="study-modal-back2" class="button small" type="button">Back to results</button>
            </div>

            <div id="study-modal-body"></div>
          </div>
        `;
        document.body.appendChild(modal);

        // Click outside card closes modal
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            e.preventDefault();
            e.stopPropagation();
            history.replaceState(null, '', '#study');
            hideModal();
          }
        });

        modal.querySelector('#study-modal-close')?.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          history.replaceState(null, '', '#study');
          hideModal();
        });
        
        modal.querySelector('#study-modal-back2')?.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          history.replaceState(null, '', '#study');
          hideModal();
        });

        // ESC closes modal
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') hideModal();
        });

        return modal;
      }

      function hideModal() {
        const modal = document.getElementById('study-modal');
        if (modal) modal.style.display = 'none';
        goBackToStudyResults();
      }

      function showModal(note) {
        // Keep Study panel active (prevents jumping back to header)
        stayOnStudyPanel();

        const modal = ensureModal();
        modal.style.display = 'block';

        const titleEl = modal.querySelector('#study-modal-title');
        const metaEl = modal.querySelector('#study-modal-meta');
        const bodyEl = modal.querySelector('#study-modal-body');

        if (titleEl) titleEl.textContent = note.title || 'Untitled';

        if (metaEl) {
          metaEl.innerHTML = `
            <span class="chip">${escapeHtml(note.category || '')}</span>
            ${note.subcategory ? `<span class="chip">${escapeHtml(note.subcategory)}</span>` : ''}
            ${note.source_url ? ` <a href="${note.source_url}" target="_blank" rel="noopener">Source</a>` : ''}
            ${note.image_url ? ` <a href="${note.image_url}" target="_blank" rel="noopener">Attachment</a>` : ''}
          `;
        }

        const file = note.image_url || '';
        const isPdf = file.toLowerCase().includes('.pdf');
        const isImage = /\.(png|jpg|jpeg|webp|gif)$/i.test(file);

        const media = note.image_url ? (
          isPdf
            ? `
              <div style="margin:.75rem 0;">
                <iframe src="${note.image_url}"
                        style="width:100%;height:520px;border:1px solid rgba(255,255,255,.2);border-radius:12px;"></iframe>
                <p style="margin:.5rem 0 0 0;">
                  <a href="${note.image_url}" target="_blank" rel="noopener">Open / Download PDF</a>
                </p>
              </div>
            `
            : isImage
              ? `
                <div style="margin:.75rem 0;">
                  <img src="${note.image_url}" alt="${escapeHtml(note.title)}"
                       style="width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.2);" />
                </div>
              `
              : `<p><a href="${note.image_url}" target="_blank" rel="noopener">Open attachment</a></p>`
        ) : '';

        const md = note.content_md ? `
          <pre style="white-space:pre-wrap;overflow:auto;border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:12px;">${escapeHtml(note.content_md)}</pre>
        ` : `<p style="opacity:.9;">No detailed content yet.</p>`;

        bodyEl.innerHTML = `${media}${md}`;
      }

      // Subtabs visibility + "All" injection
      function setSubtabsVisible() {
        if (!subtabs) return;
        subtabs.style.display = (activeCategory === 'SQL') ? '' : 'none';
      }

      function ensureAllButtonExists() {
        if (!subtabs) return;
        if (subtabs.querySelector('button[data-sub="__ALL__"]')) return;

        const allBtn = document.createElement('button');
        allBtn.dataset.sub = '__ALL__';
        allBtn.textContent = 'All';

        // Insert first
        subtabs.insertBefore(allBtn, subtabs.firstChild);
      }

      function setActiveSubtabButton() {
        if (!subtabs) return;
        ensureAllButtonExists();

        const btns = Array.from(subtabs.querySelectorAll('button[data-sub]'));
        btns.forEach(b => b.classList.remove('active'));

        const key = activeSubcategory === null ? '__ALL__' : activeSubcategory;
        const target = subtabs.querySelector(`button[data-sub="${CSS.escape(key)}"]`) || subtabs.querySelector('button[data-sub="__ALL__"]');
        target?.classList.add('active');
      }

      // Auth UI
      function setAuthUI(session) {
        const isAuthed = !!session;
        if (locked) locked.style.display = isAuthed ? 'none' : '';
        if (unlocked) unlocked.style.display = isAuthed ? '' : 'none';

        setSubtabsVisible();
        setActiveSubtabButton();

        if (isAuthed) {
          stayOnStudyPanel();
          loadNotes();
        }
      }

      function showAuthError(msg) {
        if (!authMsg) return;
        authMsg.textContent = msg || 'Sign-in failed';
        authMsg.style.display = '';
      }

      // Events
      signinForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (authMsg) authMsg.style.display = 'none';

        const email = e.target.email.value.trim();
        const password = e.target.password.value;

        const { data, error } = await window.__SUPABASE__.auth.signInWithPassword({ email, password });
        console.log('[Study] signIn result:', { data, error });
        if (error) showAuthError(error.message);
      });

      signoutBtn?.addEventListener('click', async () => {
        const { error } = await window.__SUPABASE__.auth.signOut();
        console.log('[Study] signOut result:', { error });
      });

      window.__SUPABASE__.auth.onAuthStateChange((evt, session) => {
        console.log('[Study] auth state:', evt, !!session);
        setAuthUI(session);
      });

      // Category tabs
      tabs?.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-cat]');
        if (!btn) return;

        activeCategory = btn.dataset.cat;
        tabs.querySelectorAll('button[data-cat]').forEach(b => b.classList.toggle('active', b === btn));

        // When switching to SQL, default to All
        if (activeCategory === 'SQL') activeSubcategory = null;

        setSubtabsVisible();
        setActiveSubtabButton();

        stayOnStudyPanel();
        loadNotes();
      });

      // SQL subtabs
      subtabs?.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-sub]');
        if (!btn) return;

        const sub = btn.dataset.sub;
        activeSubcategory = (sub === '__ALL__') ? null : sub;

        setActiveSubtabButton();

        stayOnStudyPanel();
        loadNotes();
      });

      // Click a note to open single view modal
      results?.addEventListener('click', (e) => {
        const card = e.target.closest('[data-note-id]');
        if (!card) return;
        const note = card.__noteData;
        if (note) showModal(note);
      });

      // Search
      searchInput?.addEventListener('input', debounce(() => loadNotes(), 250));

      // Tags normalization
      function normalizeTags(tags) {
        if (!tags) return [];
        if (Array.isArray(tags)) return tags;

        if (typeof tags === 'string') {
          const s = tags.trim();
          if (s.startsWith('[')) {
            try {
              const parsed = JSON.parse(s);
              return Array.isArray(parsed) ? parsed : [];
            } catch (_) {
              return [];
            }
          }
          return s.split(',').map(x => x.trim()).filter(Boolean);
        }
        return [];
      }

      // IMPORTANT: use DIV, not ARTICLE (Dimension hides nested articles inside #main)
      function renderNote(n) {
        const tags = normalizeTags(n.tags).map(t => `<span class="chip">${escapeHtml(t)}</span>`).join('');
        const src = n.source_url ? `<a href="${n.source_url}" target="_blank" rel="noopener">Source</a>` : '';
        const updated = n.updated_at ? `<small>Updated: ${new Date(n.updated_at).toLocaleDateString()}</small>` : '';
        const sub = n.subcategory ? `<span class="chip">${escapeHtml(n.subcategory)}</span>` : '';
        const attach = n.image_url ? `<span class="chip">Attachment</span>` : '';

        return `
          <div class="note" data-note-id="${escapeHtml(n.id)}" role="button" tabindex="0" style="cursor:pointer;">
            <h4>${escapeHtml(n.title)}</h4>
            <p>${escapeHtml(n.summary || '')}</p>
            <div class="meta">${sub} ${attach} ${tags} ${src} ${updated}</div>
          </div>
        `;
      }

      async function loadNotes() {
        if (!results) return;

        results.innerHTML = '<p>Loading‚Ä¶</p>';
        setStudyStatus(`Loading ${activeCategory}${activeCategory === 'SQL' ? (activeSubcategory ? ' ‚Üí ' + activeSubcategory : ' ‚Üí All') : ''}‚Ä¶`);

        let query = window.__SUPABASE__
          .from('study_notes')
          .select('id, category, subcategory, title, summary, content_md, tags, source_url, updated_at, sort_order, image_url')
          .eq('category', activeCategory);

        // Only filter by subcategory when SQL + selected subcategory
        if (activeCategory === 'SQL' && activeSubcategory) {
          query = query.eq('subcategory', activeSubcategory);
        }

        query = query
          .order('sort_order', { ascending: true, nullsFirst: true })
          .order('updated_at', { ascending: false });

        const q = (searchInput?.value || '').trim();
        if (!isEmpty(q)) {
          query = query.textSearch('fts', q, { type: 'websearch' });
        }

        const { data, error } = await query.limit(100);

        console.log('[Study] loadNotes:', {
          category: activeCategory,
          subcategory: activeCategory === 'SQL' ? (activeSubcategory || 'All') : null,
          q,
          count: data?.length ?? 0,
          error
        });

        if (error) {
          setStudyStatus(`Error: ${error.message}`);
          results.innerHTML = `<p class="warn">${escapeHtml(error.message)}<br><small>If this mentions RLS/permission, add a SELECT policy for authenticated users on public.study_notes.</small></p>`;
          return;
        }

        setStudyStatus(`Loaded ${data?.length ?? 0} notes for ${activeCategory}${activeCategory === 'SQL' ? (activeSubcategory ? ' ‚Üí ' + activeSubcategory : ' ‚Üí All') : ''}.`);

        if (!data || data.length === 0) {
          results.innerHTML = `<p>No notes found.</p>`;
          return;
        }

        results.innerHTML = data.map(renderNote).join('');

        // Attach note data so click opens the correct note
        const cards = Array.from(results.querySelectorAll('[data-note-id]'));
        cards.forEach((el, idx) => { el.__noteData = data[idx]; });
      }

      // Init
      const { data: s, error: sessErr } = await window.__SUPABASE__.auth.getSession();
      console.log('[Study] initial session:', { hasSession: !!s?.session, sessErr });

      setSubtabsVisible();
      setActiveSubtabButton();
      setAuthUI(s.session);
    </script>

    <!-- [JS-3] Labs: Game launcher + gameplay + scoring + paywall -->
     <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ---- Single shared Supabase client (auth/membership only; quizzes are LOCAL) ----
  if (!window.__SUPABASE__) {
    window.__SUPABASE__ = createClient(
      'https://uymuwikmssxdtbeocoyf.supabase.co',
      'sb_publishable_ER4iXdw7aQRT25icZttTug_p3YJEPxW'
    );
  }
  const supabase = window.__SUPABASE__;

  const $ = (id) => document.getElementById(id);

  function onReady(fn) {
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
    else fn();
  }

  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function assertEls(ids) {
    const missing = ids.filter((id) => !$(id));
    if (missing.length) {
      console.error('[Labs] Missing required IDs:', missing);
      return false;
    }
    return true;
  }

  onReady(async () => {
    if (!document.querySelector('article#labs')) return;

    const REQUIRED = [
      'labs-category', 'labs-games', 'labs-difficulty', 'labs-helper',
      'labs-score', 'labs-streak', 'labs-badges', 'labs-access',
      'labs-launcher', 'labs-cardwrap',
      'labs-card-title', 'labs-card-sub', 'labs-helpertext',
      'labs-code', 'labs-actions', 'labs-feedback', 'labs-paywall',
      'labs-back', 'labs-next', 'labs-reset'
    ];
    if (!assertEls(REQUIRED)) return;

    // ---- DOM bindings ----
    const el = {
      category: $('labs-category'),
      games: $('labs-games'),
      difficulty: $('labs-difficulty'),
      helper: $('labs-helper'),
      score: $('labs-score'),
      streak: $('labs-streak'),
      badges: $('labs-badges'),
      access: $('labs-access'),
      launcher: $('labs-launcher'),
      cardwrap: $('labs-cardwrap'),
      title: $('labs-card-title'),
      sub: $('labs-card-sub'),
      helperText: $('labs-helpertext'),
      code: $('labs-code'),
      actions: $('labs-actions'),
      feedback: $('labs-feedback'),
      paywall: $('labs-paywall'),
      back: $('labs-back'),
      next: $('labs-next'),
      reset: $('labs-reset'),
    };

    // ---- State ----
    let activeCat = 'SQL';
    let difficulty = 'rookie';
    let helperMode = true;

    let score = 0;
    let streak = 0;
    const badges = new Set();

    let session = null;
    let isPaid = false;

    const FREE_ROUNDS = 7;
    const FREE_ROUNDS_HARD = 4;
    let roundsThisSession = 0;

    let activeGame = null; // { id, name, run(), next?, reset? }

    function updateMeta() {
      el.score.textContent = String(score);
      el.streak.textContent = String(streak);
      el.badges.textContent = badges.size ? Array.from(badges).join(', ') : '‚Äî';
      el.access.innerHTML = `Access: <strong>${isPaid ? 'Member' : 'Free'}</strong>`;
    }

    function awardBadge(name) {
      if (!name) return;
      badges.add(name);
      updateMeta();
    }

    function maxFreeRounds() {
      if (isPaid) return Infinity;
      return (difficulty === 'rookie') ? FREE_ROUNDS : FREE_ROUNDS_HARD;
    }

    function requireAccessOrPaywall() {
      if (roundsThisSession >= maxFreeRounds()) {
        el.paywall.style.display = '';
        el.paywall.textContent = 'Free limit reached for this difficulty. Members get unlimited rounds.';
        return false;
      }
      el.paywall.style.display = 'none';
      return true;
    }

    async function refreshSessionAndMembership() {
      try {
        const { data } = await supabase.auth.getSession();
        session = data?.session ?? null;
      } catch (_) {
        session = null;
      }

      isPaid = false;
      if (session?.user?.id) {
        try {
          const { data: mem } = await supabase
            .from('memberships')
            .select('is_paid')
            .eq('user_id', session.user.id)
            .maybeSingle();
          isPaid = !!mem?.is_paid;
        } catch (_) {
          isPaid = false;
        }
      }
      updateMeta();
    }

  function showLauncher() {
  activeGame = null;

  el.launcher.style.display = 'block';
  el.cardwrap.style.display = 'none';

  el.feedback.textContent = '';
  el.actions.innerHTML = '';
  el.code.textContent = '';
  el.helperText.textContent = '';
  el.paywall.style.display = 'none';

  if (location.hash !== '#labs') history.replaceState(null, '', '#labs');
}

function showCard() {
  el.launcher.style.display = 'none';
  el.cardwrap.style.display = 'block';   // <-- key change (was '')

  if (location.hash !== '#labs') history.replaceState(null, '', '#labs');
  setTimeout(() => el.cardwrap.scrollIntoView({ behavior: 'smooth', block: 'start' }), 60);
}

    // ---- Answer renderer (SINGLE) ----
    function renderAnswers({ answers, explain }, lockRef, badgeOnCorrect = null) {
      el.actions.innerHTML = '';
      el.feedback.textContent = '';

      shuffle(answers || []).forEach((a) => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'button';
        b.style.textAlign = 'left';
        b.textContent = a.t;

        b.addEventListener('click', () => {
          if (lockRef.locked) return;
          lockRef.locked = true;

          if (a.ok) {
            score += (difficulty === 'rookie' ? 10 : difficulty === 'pro' ? 15 : 20);
            streak += 1;
            el.feedback.textContent = `‚úÖ Correct. ${explain || ''}`;
            if (streak >= 3) awardBadge('Hot Streak');
            if (badgeOnCorrect) awardBadge(badgeOnCorrect);
          } else {
            streak = 0;
            el.feedback.textContent = `‚ùå Not quite. ${explain || ''}`;
          }
          updateMeta();
        });

        el.actions.appendChild(b);
      });
    }

    // ============================
    // SQL BANK (LOCAL)
    // ============================
    const SQL_BANK = [
      {
        topic: 'CTEs',
        title: 'Playoff seeding: rank teams by total points',
        q: 'Which pattern correctly reuses an aggregate and ranks the results?',
        code: `WITH totals AS (
  SELECT team_id, SUM(points) AS pts
  FROM game_scores
  GROUP BY 1
),
ranked AS (
  SELECT *, DENSE_RANK() OVER (ORDER BY pts DESC) AS rnk
  FROM totals
)
SELECT * FROM ranked WHERE rnk <= 5;`,
        answers: [
          { t: 'Aggregate in a CTE, then window-rank the aggregate (shown).', ok: true },
          { t: 'Put SUM(points) and DENSE_RANK() in the same grouped SELECT.', ok: false },
          { t: 'Use correlated subqueries everywhere.', ok: false },
          { t: 'Use DISTINCT ON without ORDER BY.', ok: false },
        ],
        explain: 'Aggregate once, then rank the aggregated rows. Clean + correct.'
      },
      {
        topic: 'Joins',
        title: 'Churn list: customers with no purchases in 30 days',
        q: 'Which query returns customers with no orders in the last 30 days?',
        code: `SELECT c.*
FROM customers c
LEFT JOIN orders o
  ON o.customer_id = c.id
 AND o.order_date >= CURRENT_DATE - INTERVAL '30 days'
WHERE o.id IS NULL;`,
        answers: [
          { t: 'Filter date in ON and anti-join with WHERE o.id IS NULL.', ok: true },
          { t: 'Filter date in WHERE (after the LEFT JOIN).', ok: false },
          { t: 'Use INNER JOIN + o.id IS NULL.', ok: false },
          { t: 'Use CROSS JOIN and filter.', ok: false },
        ],
        explain: 'Right-table filters in WHERE can collapse a LEFT JOIN into an INNER JOIN.'
      },
      {
        topic: 'Window',
        title: 'Hot streak: running total per player',
        q: 'Which window definition produces a running total per player ordered by game date?',
        code: `SELECT player_id, game_dt,
       SUM(points) OVER (
         PARTITION BY player_id
         ORDER BY game_dt
         ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
       ) AS running_points
FROM player_game_stats;`,
        answers: [
          { t: 'PARTITION BY player_id + ORDER BY game_dt (shown).', ok: true },
          { t: 'GROUP BY player_id, game_dt.', ok: false },
          { t: 'ORDER BY player_id only.', ok: false },
          { t: 'PARTITION BY game_dt.', ok: false },
        ],
        explain: 'Running metrics need ORDER BY inside the window and a partition by entity.'
      },
      {
        topic: 'Indexing',
        title: 'Support tickets: filter + sort + limit',
        q: 'What index best supports this query pattern?',
        code: `SELECT *
FROM tickets
WHERE customer_id = $1
ORDER BY created_at DESC
LIMIT 50;`,
        answers: [
          { t: 'Index (customer_id, created_at DESC).', ok: true },
          { t: 'Index created_at only.', ok: false },
          { t: 'Index message_text only.', ok: false },
          { t: 'No index helps ORDER BY.', ok: false },
        ],
        explain: 'A composite index aligned to filter+sort avoids scanning/sorting large sets.'
      },
      {
        topic: 'Aggregations',
        title: 'Revenue QA: WHERE vs HAVING',
        q: 'Which statement is true about WHERE vs HAVING?',
        code: `SELECT region, SUM(revenue) AS rev
FROM f_sales
GROUP BY 1
HAVING SUM(revenue) > 1000000;`,
        answers: [
          { t: 'WHERE filters rows before grouping; HAVING filters groups after.', ok: true },
          { t: 'HAVING is always faster than WHERE.', ok: false },
          { t: 'WHERE can reference SUM(revenue).', ok: false },
          { t: 'HAVING works only with COUNT(*).', ok: false },
        ],
        explain: 'HAVING is evaluated after aggregation; WHERE is before.'
      },
      {
        topic: 'Window',
        title: 'Deterministic row numbering',
        q: 'Which window function assigns 1..N within each partition with deterministic ordering?',
        code: `SELECT
  ROW_NUMBER() OVER(PARTITION BY team ORDER BY pts DESC) AS rn
FROM leaderboard;`,
        answers: [
          { t: 'ROW_NUMBER()', ok: true },
          { t: 'RANK()', ok: false },
          { t: 'COUNT(*)', ok: false },
          { t: 'DENSE_RANK() always equals ROW_NUMBER()', ok: false },
        ],
        explain: 'ROW_NUMBER gives a unique sequence; RANK/DENSE_RANK handle ties differently.'
      },
    ];

    // ============================
    // SQL QUIZ CONTROLLER (SINGLE)
    // ============================
    const SQL_QUIZ_SIZE = 7;
    let sqlSet = [];
    let sqlIdx = 0;
    const sqlLock = { locked: false };

    function buildSqlSet() {
      sqlSet = shuffle(SQL_BANK).slice(0, Math.min(SQL_QUIZ_SIZE, SQL_BANK.length));
      sqlIdx = 0;
      sqlLock.locked = false;
    }

    function runSqlQuiz() {
      if (!requireAccessOrPaywall()) return;
      if (!sqlSet.length) buildSqlSet();

      const item = sqlSet[sqlIdx];
      if (!item) return;

      roundsThisSession += 1;
      showCard();

      el.title.textContent = 'SQL Quiz';
      el.sub.textContent = `Question ${sqlIdx + 1}/${sqlSet.length} ‚Ä¢ ${item.topic} ‚Ä¢ ${difficulty}`;
      el.helperText.textContent = helperMode ? 'Pick the best production-safe answer. Read the explanation after.' : '';
      el.code.textContent = `${item.q}\n\n${item.code || ''}`;

      sqlLock.locked = false;
      renderAnswers({ answers: item.answers, explain: item.explain }, sqlLock);
    }

    function nextSqlQuiz() {
      if (!sqlSet.length) buildSqlSet();

      if (sqlIdx < sqlSet.length - 1) {
        sqlIdx += 1;
        sqlLock.locked = false;
        runSqlQuiz();
      } else {
        showCard();
        el.title.textContent = 'SQL Quiz';
        el.sub.textContent = `Complete ‚Ä¢ Score: ${score}`;
        el.helperText.textContent = '';
        el.code.textContent = '';
        el.actions.innerHTML = '';
        el.feedback.textContent = 'üéâ Quiz complete. Press Reset for a new randomized set.';
      }
    }

    function resetSqlQuiz() {
      roundsThisSession = 0;
      el.paywall.style.display = 'none';
      buildSqlSet();
      runSqlQuiz();
    }

    // ============================
    // SQL Debugger + Query Builder
    // ============================
    const oneLock = { locked: false };

    function runSqlDebugger() {
      if (!requireAccessOrPaywall()) return;

      roundsThisSession += 1;
      showCard();

      el.title.textContent = 'SQL Debugger';
      el.sub.textContent = `Fix the logic bug ‚Ä¢ ${difficulty}`;
      el.helperText.textContent = helperMode ? 'Hint: WHERE filters can change LEFT JOIN behavior.' : '';

      el.code.textContent =
`-- Bug: this removes customers with no orders (LEFT JOIN collapses)
SELECT c.*
FROM customers c
LEFT JOIN orders o ON o.customer_id = c.id
WHERE o.status = 'PAID';`;

      oneLock.locked = false;
      renderAnswers({
        answers: [
          { t: "Move o.status = 'PAID' into the ON clause.", ok: true },
          { t: 'Use INNER JOIN instead.', ok: false },
          { t: 'Add DISTINCT to remove duplicates.', ok: false },
          { t: 'Remove the filter entirely.', ok: false },
        ],
        explain: "Put right-table filters in ON to preserve unmatched rows in a LEFT JOIN."
      }, oneLock, 'Join Logic');
    }

    function runQueryBuilder() {
      if (!requireAccessOrPaywall()) return;

      roundsThisSession += 1;
      showCard();

      el.title.textContent = 'Query Builder';
      el.sub.textContent = `Choose the best pattern ‚Ä¢ ${difficulty}`;
      el.helperText.textContent = helperMode ? 'Goal: include ties, keep it readable, avoid nondeterminism.' : '';

      el.code.textContent =
`Requirement:
Return top 5 departments by total spend this month, INCLUDING ties.

Which pattern is best?`;

      oneLock.locked = false;
      renderAnswers({
        answers: [
          { t: 'CTE aggregate + DENSE_RANK() then filter rnk <= 5.', ok: true },
          { t: 'GROUP BY then LIMIT 5.', ok: false },
          { t: 'COUNT(*) OVER() for ranking.', ok: false },
          { t: 'DISTINCT ON without ORDER BY.', ok: false },
        ],
        explain: 'DENSE_RANK handles ties; CTE keeps the aggregate reusable and clear.'
      }, oneLock, 'Pattern Picker');
    }

// ============================
// PYTHON decision games (LOCAL) ‚Äî FIXED
// Replace your entire PY_GAMES + pyLock + runPythonGame block with this
// ============================
const PY_GAMES = {
  pipeline: {
    name: 'Pipeline Sim',
    bank: {
      rookie: [
        {
          title: 'Late correction from sports API',
          helper: 'Goal: correctness + auditability + minimal recompute.',
          data: [
            { event_id: 'e1', game_id: 551, player: 'QB7', yards: 312 },
            { event_id: 'e2', game_id: 551, player: 'QB7', yards: 305, note: 'correction' }
          ],
          answers: [
            { t: 'Idempotent upsert keyed by (game_id, player) + versioning + audit log; backfill only affected partition.', ok: true },
            { t: 'Rebuild the entire warehouse nightly to be safe.', ok: false },
            { t: 'Ignore corrections to keep latency low.', ok: false },
            { t: 'Manually edit the dashboard when corrections arrive.', ok: false }
          ],
          explain: 'Versioned idempotent writes + scoped backfills keep cost low and trust high.',
          badge: 'Late Data Master'
        },
        {
          title: 'Incremental ingest from live stats feed',
          helper: 'Goal: avoid duplicates, keep pipeline fast, preserve history.',
          data: {
            source: 'live_stats_api',
            last_run_max_ts: '2024-11-10T21:05:00Z',
            incoming: [
              { event_id: 'p101', game_id: 778, player: 'WR12', yards: 18, updated_at: '2024-11-10T21:05:10Z' },
              { event_id: 'p102', game_id: 778, player: 'RB4',  yards: 6,  updated_at: '2024-11-10T21:06:02Z' }
            ]
          },
          answers: [
            { t: 'Filter source by updated_at > last_run_max_ts, upsert on event_id, and advance watermark.', ok: true },
            { t: 'Truncate the table and reload all events every run.', ok: false },
            { t: 'Append everything and deduplicate later in dashboards.', ok: false },
            { t: 'Ignore timestamps and trust API ordering.', ok: false }
          ],
          explain: 'Incremental ETL uses a watermark (max timestamp) plus idempotent upserts to stay fast and correct.',
          badge: 'Incremental ETL'
        },
        {
          title: 'Joining play-by-play with roster data',
          helper: 'Goal: keep pipelines resilient when upstream systems change.',
          data: {
            feeds: {
              play_by_play: 'API_A (real-time)',
              roster: 'API_B (daily snapshot)'
            },
            issue: 'Player IDs occasionally change mid-season'
          },
          answers: [
            { t: 'Stage both feeds separately, map to a stable surrogate key, and join downstream.', ok: true },
            { t: 'Join APIs directly in-memory before writing to storage.', ok: false },
            { t: 'Assume player IDs never change and hard-code joins.', ok: false },
            { t: 'Drop plays that fail to join to roster.', ok: false }
          ],
          explain: 'Robust ETL separates ingestion from modeling and uses surrogate keys to handle upstream instability.',
          badge: 'Data Flow Architect'
        }
      ],
      pro: [
        {
          title: 'Schema drift mid-season',
          helper: 'Goal: don‚Äôt break prod. Preserve new signal safely.',
          data: [
            { game_id: 202, player_id: 7, rush_yards: 84 },
            { game_id: 202, player_id: 7, rush_yards: 84, yac_yards: 18, note: 'new field' }
          ],
          answers: [
            { t: 'Support schema evolution + contracts/tests; accept nullable new column and backfill when safe.', ok: true },
            { t: 'Fail the pipeline until the field disappears.', ok: false },
            { t: 'Cast everything to text and move on.', ok: false },
            { t: 'Drop the new field always.', ok: false }
          ],
          explain: 'Backwards-compatible evolution + contracts prevents breakages and keeps analytics usable.',
          badge: 'Schema Tamer'
        }
      ],
      front_office: [
        {
          title: 'Conflicting sources: official vs third-party',
          helper: 'Goal: pick source-of-truth, quarantine conflicts, alert.',
          data: [
            { source: 'official', game_id: 303, team: 'A', points: 24 },
            { source: 'third_party', game_id: 303, team: 'A', points: 27 }
          ],
          answers: [
            { t: 'Use official as truth, quarantine mismatches, alert + investigate.', ok: true },
            { t: 'Average the two values.', ok: false },
            { t: 'Always trust third-party because it‚Äôs faster.', ok: false },
            { t: 'Hide the game from dashboards.', ok: false }
          ],
          explain: 'Governance means deterministic truth + surfacing anomalies, not blending conflicting facts.',
          badge: 'Governance Guard'
        }
      ]
    }
  },

  fantasy: {
    name: 'Fantasy Architect',
    bank: {
      rookie: [
        {
          title: 'Consistency vs outliers',
          helper: 'Goal: separate signal from noise. Show a metric that NFL would recognize.',
          data: [
            { player: 'WR1', week: 1, pts: 8 },
            { player: 'WR1', week: 2, pts: 22 },
            { player: 'WR1', week: 3, pts: 4 },
            { player: 'WR1', week: 4, pts: 18 }
          ],
          answers: [
            { t: 'Use rolling average + variance (or CV) to show consistency.', ok: true },
            { t: 'Rank by best single week.', ok: false },
            { t: 'Use last week only.', ok: false },
            { t: 'Use total points only (ignore volatility).', ok: false }
          ],
          explain: 'A rolling mean plus variance communicates consistency and recency without overfitting.',
          badge: 'Bias Detector'
        }
      ],
      pro: [
        {
          title: 'Small-sample trap',
          helper: 'Goal: avoid overrating a player with only 2 games played.',
          data: [
            { player: 'RB2', games: 2, avg_pts: 29, note: 'small sample' },
            { player: 'RB3', games: 8, avg_pts: 12.3, note: 'stable' }
          ],
          answers: [
            { t: 'Apply shrinkage / prior toward league average OR require minimum games.', ok: true },
            { t: 'Always choose the highest average.', ok: false },
            { t: 'Drop the stable player because it‚Äôs boring.', ok: false },
            { t: 'Use max points only.', ok: false }
          ],
          explain: 'Shrinkage/min-games prevents small sample hype from dominating decisions.',
          badge: 'Cost Optimizer'
        }
      ],
      front_office: [
        {
          title: 'Risk-adjusted ranking',
          helper: 'Goal: incorporate injury risk into expected value.',
          data: [
            { player: 'QB2', proj_pts: 24, injury_risk: 0.35 },
            { player: 'QB3', proj_pts: 20, injury_risk: 0.05 }
          ],
          answers: [
            { t: 'Rank by risk-adjusted expected value (EV * availability).', ok: true },
            { t: 'Always pick highest projection.', ok: false },
            { t: 'Always pick lowest risk.', ok: false },
            { t: 'Ignore injury risk.', ok: false }
          ],
          explain: 'Front office decisions are about EV under uncertainty, not raw point estimates.',
          badge: 'Front Office Mindset'
        }
      ]
    }
  },

  trade: {
    name: 'Trade Deadline',
    bank: {
      rookie: [
        {
          title: 'Win-now move under cap',
          helper: 'Goal: balance impact with cap constraints.',
          data: {
            cap_space: 8,
            playerA: { name: 'Wing A', impact: 7.5, risk: 0.20, cost: 7 },
            playerB: { name: 'Wing B', impact: 6.2, risk: 0.05, cost: 5 }
          },
          answers: [
            { t: 'Wing A: higher impact and fits cap.', ok: true },
            { t: 'Wing B: lowest risk always wins.', ok: false },
            { t: 'Trade for both.', ok: false },
            { t: 'Trade for neither.', ok: false }
          ],
          explain: 'If you‚Äôre win-now, impact that fits constraints usually dominates‚Äîwhile still tracking risk.',
          badge: 'Deadline Dealer'
        }
      ],
      pro: [
        {
          title: 'Rebuild strategy',
          helper: 'Goal: prefer upside + flexibility, avoid locking cap into risky vets.',
          data: {
            cap_space: 10,
            vet: { impact: 8.0, risk: 0.25, cost: 9 },
            prospect: { impact: 5.5, risk: 0.08, cost: 4, upside: 9.0 }
          },
          answers: [
            { t: 'Prospect: cheaper + upside + aligns with rebuild.', ok: true },
            { t: 'Vet: highest impact now.', ok: false },
            { t: 'Both: go all in.', ok: false },
            { t: 'Neither: do nothing.', ok: false }
          ],
          explain: 'Strategy alignment matters: rebuild decisions favor optionality and upside.',
          badge: 'Strategy Aligner'
        }
      ],
      front_office: [
        {
          title: 'Two similar options: fit vs impact',
          helper: 'Goal: fit + availability can beat slightly higher impact.',
          data: {
            cap_space: 6,
            options: [
              { name: 'Shooter', impact: 6.8, risk: 0.12, cost: 6, fit: 'high' },
              { name: 'Defender', impact: 6.3, risk: 0.06, cost: 5, fit: 'very_high' }
            ]
          },
          answers: [
            { t: 'Defender: better fit + lower risk + cheaper.', ok: true },
            { t: 'Shooter: slightly higher impact.', ok: false },
            { t: 'Wait for buyout market.', ok: false },
            { t: 'Trade neither.', ok: false }
          ],
          explain: 'In playoffs, availability + fit frequently beat small impact edges.',
          badge: 'Roster Scientist'
        }
      ]
    }
  }
};

const pyLock = { locked: false };

function runPythonGame(gameKey) {
  const game = PY_GAMES[gameKey];
  if (!game) return;

  const bank = game.bank?.[difficulty] || game.bank?.rookie || [];
  const scenario = bank[Math.floor(Math.random() * bank.length)];
  if (!scenario) return;

  if (!requireAccessOrPaywall()) return;

  roundsThisSession += 1;
  showCard();

  el.title.textContent = game.name;
  el.sub.textContent = `${scenario.title} ‚Ä¢ ${difficulty}`;
  el.helperText.textContent = helperMode ? (scenario.helper || '') : '';
  el.code.textContent = (typeof scenario.data === 'string')
    ? scenario.data
    : JSON.stringify(scenario.data, null, 2);

  pyLock.locked = false;
  renderAnswers({ answers: scenario.answers, explain: scenario.explain }, pyLock, scenario.badge || null);
}

    // ============================
    // Game registry + wiring
    // ============================
    const GAMES = {
      SQL: [
        { id: 'sql_quiz', name: 'SQL Quiz', run: runSqlQuiz, next: nextSqlQuiz, reset: resetSqlQuiz },
        { id: 'sql_debug', name: 'SQL Debugger', run: runSqlDebugger, next: runSqlDebugger, reset: runSqlDebugger },
        { id: 'sql_builder', name: 'Query Builder', run: runQueryBuilder, next: runQueryBuilder, reset: runQueryBuilder },
      ],
      Python: [
        { id: 'pipe', name: 'Pipeline Sim', run: () => runPythonGame('pipeline'), next: () => runPythonGame('pipeline'), reset: () => runPythonGame('pipeline') },
        { id: 'fantasy', name: 'Fantasy Architect', run: () => runPythonGame('fantasy'), next: () => runPythonGame('fantasy'), reset: () => runPythonGame('fantasy') },
        { id: 'trade', name: 'Trade Deadline', run: () => runPythonGame('trade'), next: () => runPythonGame('trade'), reset: () => runPythonGame('trade') },
      ]
    };

    function renderGamesRow() {
      el.games.innerHTML = '';
      const list = GAMES[activeCat] || [];

      list.forEach((g) => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'button';
        b.textContent = g.name;
        b.dataset.game = g.id;

        b.addEventListener('click', () => {
          activeGame = g;
          roundsThisSession = 0;
          el.paywall.style.display = 'none';

          if (g.id === 'sql_quiz') buildSqlSet();
          g.run();
        });

        el.games.appendChild(b);
      });
    }

    // Category buttons
    el.category.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-cat]');
      if (!btn) return;

      activeCat = btn.dataset.cat;
      el.category.querySelectorAll('button[data-cat]').forEach((b) => b.classList.toggle('active', b === btn));

      renderGamesRow();
      showLauncher();
    });

    // Difficulty buttons
    el.difficulty.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-diff]');
      if (!btn) return;

      difficulty = btn.dataset.diff;
      el.difficulty.querySelectorAll('button[data-diff]').forEach((b) => b.classList.toggle('active', b === btn));

      roundsThisSession = 0;
      el.paywall.style.display = 'none';
      if (activeGame) activeGame.run();
    });

    // Helper toggle
    el.helper.addEventListener('change', () => {
      helperMode = !!el.helper.checked;
      if (activeGame) activeGame.run();
    });

    // Top buttons
    el.back.addEventListener('click', () => showLauncher());
    el.next.addEventListener('click', () => { if (activeGame?.next) activeGame.next(); });
    el.reset.addEventListener('click', () => { if (activeGame?.reset) activeGame.reset(); });

    // Init
    await refreshSessionAndMembership();
    renderGamesRow();
    showLauncher();

    try {
      supabase.auth.onAuthStateChange(async () => {
        await refreshSessionAndMembership();
      });
    } catch (_) {}

    console.log('[Labs] ready ‚úÖ');
  });
</script>

<!-- Begin [JS-4] Recruiter Gate (fixed + wired) -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // Shared Supabase client
  if (!window.__SUPABASE__) {
    window.__SUPABASE__ = createClient(
      'https://uymuwikmssxdtbeocoyf.supabase.co',
      'sb_publishable_ER4iXdw7aQRT25icZttTug_p3YJEPxW'
    );
  }
  const sb = window.__SUPABASE__;

  // Local helpers (no name collisions with other modules)
  const byId = (id) => document.getElementById(id);
  const escapeHtml = (str) =>
    String(str ?? '').replace(/[&<>"']/g, (m) => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
    }[m]));

  // --------------------------
  // Recruiter Gate config/state
  // --------------------------
  function recruiterGateQuestions() {
    return [
      {
        id: 'role_scope',
        prompt: "What role and team would the recruiter be recruiting for?",
        placeholder: "Example: Senior Analytics Engineer on Data Platform (Team X)‚Ä¶",
        minLen: 10
      },
      {
        id: 'comp_range',
        prompt: "What compensation range has the recruiter been given for this role?",
        placeholder: "Example: $120k‚Äì$150k base + bonus‚Ä¶",
        minLen: 6
      },
      {
        id: 'process_next',
        prompt: "What would the hiring manager say the next step and timeline is (screen, panel, decision date)?",
        placeholder: "Example: recruiter screen this week, HM round next week, decision by‚Ä¶",
        minLen: 10
      }
    ];
  }

  const STORAGE_KEY = 'resume_gate_unlocked_v2';

  function isUnlocked() {
    return localStorage.getItem(STORAGE_KEY) === '1';
  }
  function setUnlocked() {
    localStorage.setItem(STORAGE_KEY, '1');
  }

    // addReward('Resume unlocked (Recruiter Gate)');
    // renderJourneyUI();

  function setDownloadEnabled(enabled) {
    const link = byId('resume-download-link');
    if (link) {
      if (enabled) {
        link.style.pointerEvents = '';
        link.style.opacity = '';
        link.setAttribute('aria-disabled', 'false');
      } else {
        link.style.pointerEvents = 'none';
        link.style.opacity = '.55';
        link.setAttribute('aria-disabled', 'true');
      }
    }

    const wrap = byId('resume-pdf-wrap');
    if (wrap) wrap.classList.toggle('is-locked', !enabled);
  }

  function openGateModal() {
    setDownloadEnabled(false);
    const modal = byId('resume-gate-modal');
    if (modal) modal.style.display = 'block';
  }

  function closeGateModal() {
    const modal = byId('resume-gate-modal');
    if (modal) modal.style.display = 'none';
    hideGateError();
  }

  function showGateError(msg) {
    const el = byId('resume-gate-err');
    if (!el) return;
    el.textContent = msg;
    el.style.display = '';
  }

  function hideGateError() {
    const el = byId('resume-gate-err');
    if (!el) return;
    el.textContent = '';
    el.style.display = 'none';
  }

  function renderGateStep(state) {
    const qwrap = byId('resume-gate-qwrap');
    const prog = byId('resume-gate-progress');
    const back = byId('resume-gate-back');
    const next = byId('resume-gate-next');
    if (!qwrap || !prog || !next) return;

    const q = state.questions[state.idx];
    prog.textContent = `Step ${state.idx + 1} of ${state.questions.length}`;

    if (back) back.style.display = (state.idx === 0) ? 'none' : '';
    next.textContent = (state.idx === state.questions.length - 1) ? 'Unlock download' : 'Next';

    const saved = state.answers[q.id] || '';

    qwrap.innerHTML = `
      <div class="labs-card" style="margin:0;">
        <h4 style="margin:0 0 .5rem 0;">${escapeHtml(q.prompt)}</h4>
        <textarea id="resume-gate-input"
          rows="4"
          style="width:100%;box-sizing:border-box;border-radius:12px;border:1px solid rgba(255,255,255,.22);background:rgba(0,0,0,.25);color:inherit;padding:12px;resize:vertical;"
          placeholder="${escapeHtml(q.placeholder)}">${escapeHtml(saved)}</textarea>
        <div style="opacity:.85;margin-top:.5rem;">Minimum detail: ${q.minLen} characters.</div>
      </div>
    `;
  }

  function readGateInput() {
    return (byId('resume-gate-input')?.value || '').trim();
  }

  function validateGateStep(state) {
    const q = state.questions[state.idx];
    const v = readGateInput();
    if (v.length < q.minLen) {
      showGateError(`Please add a little more detail (at least ${q.minLen} characters).`);
      return null;
    }
    hideGateError();
    return v;
  }

  // --------------------------
  // REAL download counter pieces
  // --------------------------
  async function logResumeDownloadEvent(payload) {
    try {
      await sb.from('resume_download_events').insert([payload]);
    } catch (e) {
      console.warn('[ResumeGate] download logging failed (non-blocking):', e);
    }
  }

  async function refreshResumeDownloadCount() {
    const chip = byId('resume-dl-count');
    if (!chip) return;

    try {
      const { data, error } = await sb.from('resume_download_count').select('total').maybeSingle();
      if (error) throw error;
      chip.textContent = `Downloads: ${data?.total ?? 0}`;
    } catch (e) {
      chip.textContent = 'Downloads: ‚Äî';
    }
  }

  function wireResumeDownloadLink() {
    const link = byId('resume-download-link');
    const msg = byId('resume-gate-msg');
    if (!link) return
    setDownloadedOnce();
    addReward('Resume downloaded + audit logged');
    renderJourneyUI();

    link.addEventListener('click', async (e) => {
      if (!isUnlocked()) {
        e.preventDefault();
        if (msg) {
          msg.textContent = 'Recruiter unlock required before download.';
          msg.style.display = '';
        }
        gateStateResetAndOpen();
        return;
      }

      // Fire-and-forget log (won‚Äôt block download)
      logResumeDownloadEvent({
        created_at: new Date().toISOString(),
        path: link.getAttribute('href') || '',
        user_agent: navigator.userAgent || '',
        referrer: document.referrer || '',
        unlocked: true
      });

      setTimeout(refreshResumeDownloadCount, 700);
    });
  }

  // --------------------------
  // Wiring + state machine
  // --------------------------
  let gateState = null;

  function gateStateResetAndOpen() {
    gateState = {
      questions: recruiterGateQuestions(),
      idx: 0,
      answers: {}
    };
    renderGateStep(gateState);
    openGateModal();
  }

// ===== Rewards + Journey (A + B) =====
const DL_FLAG_KEY = 'resume_gate_downloaded_v1';
const REWARDS_KEY = 'recruiter_rewards_v1';

function getRewards() {
  try { return JSON.parse(localStorage.getItem(REWARDS_KEY) || '[]'); }
  catch { return []; }
}
function saveRewards(arr) {
  localStorage.setItem(REWARDS_KEY, JSON.stringify(arr.slice(0, 50)));
}
function addReward(label) {
  const cur = getRewards();
  if (!cur.includes(label)) {
    cur.unshift(label);
    saveRewards(cur);
    renderRewardsUI();
    showToast('üéÅ Reward unlocked', label);
    showTrophyFab(true);
  }
}

function hasDownloadedOnce() {
  return localStorage.getItem(DL_FLAG_KEY) === '1';
}
function setDownloadedOnce() {
  localStorage.setItem(DL_FLAG_KEY, '1');
}

let toastTimer = null;
function showToast(title, sub) {
  const t = byId('reward-toast');
  if (!t) return;
  t.innerHTML = `<strong>${escapeHtml(title)}</strong>${sub ? `<div class="sub">${escapeHtml(sub)}</div>` : ''}`;
  t.style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { t.style.display = 'none'; }, 3200);
}

function showTrophyFab(show) {
  const fab = byId('trophy-fab');
  if (!fab) return;
  fab.style.display = show ? 'block' : 'none';
}

function openTrophyDrawer() {
  const d = byId('trophy-drawer');
  if (d) d.style.display = 'block';
}
function closeTrophyDrawer() {
  const d = byId('trophy-drawer');
  if (d) d.style.display = 'none';
}

function renderRewardsUI() {
  const list = byId('trophy-rewards-list');
  const chip = byId('journey-rewards');
  const rewards = getRewards();

  if (chip) chip.innerHTML = `Rewards: <strong>${rewards.length}</strong>`;

  if (list) {
    list.innerHTML = rewards.length
      ? rewards.map(r => `<li>${escapeHtml(r)}</li>`).join('')
      : `<li class="muted">No rewards yet. Unlock the resume to start.</li>`;
  }
}

function renderJourneyUI() {
  const status = byId('journey-status');
  const stage = byId('journey-stage');

  const unlocked = isUnlocked();
  const downloaded = hasDownloadedOnce();

  // Stage is 0/2 locked, 1/2 unlocked, 2/2 downloaded
  const stageNum = downloaded ? 2 : unlocked ? 1 : 0;

  if (status) status.innerHTML = `Status: <strong>${downloaded ? 'Downloaded' : unlocked ? 'Unlocked' : 'Locked'}</strong>`;
  if (stage) stage.innerHTML = `Stage: <strong>${stageNum} / 2</strong>`;

  renderRewardsUI();

  // Only show trophy if any rewards exist
  showTrophyFab(getRewards().length > 0);
}

  function initRecruiterGateUX() {
    if (!byId('resume-gate') || !byId('resume-download-link')) return;

    // Initial lock state
    setDownloadEnabled(isUnlocked());
    renderJourneyUI();

    // Open modal from button + overlay
    byId('resume-unlock-btn')?.addEventListener('click', gateStateResetAndOpen);
    byId('resume-mask-overlay')?.addEventListener('click', gateStateResetAndOpen);

    // Close modal
    byId('resume-gate-close')?.addEventListener('click', closeGateModal);

    // Back / Next
    byId('resume-gate-back')?.addEventListener('click', () => {
      if (!gateState) return;
      gateState.idx = Math.max(0, gateState.idx - 1);
      renderGateStep(gateState);
    });

    byId('resume-gate-next')?.addEventListener('click', () => {
      if (!gateState) gateStateResetAndOpen();

      const v = validateGateStep(gateState);
      if (v == null) return;

      const q = gateState.questions[gateState.idx];
      gateState.answers[q.id] = v;

      if (gateState.idx < gateState.questions.length - 1) {
        gateState.idx += 1;
        renderGateStep(gateState);
        return;
      }

      // Finished all 3 steps ‚Üí unlock
      setUnlocked();
      setDownloadEnabled(true);
      closeGateModal();
    });

    // Download link behavior + counter
    wireResumeDownloadLink();
    refreshResumeDownloadCount();
  }

  // DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRecruiterGateUX);
  } else {
    initRecruiterGateUX();
  }

  // ---- Journey + Trophy wiring ----
byId('journey-start')?.addEventListener('click', () => gateStateResetAndOpen());
byId('journey-view-rewards')?.addEventListener('click', () => openTrophyDrawer());
byId('journey-reset')?.addEventListener('click', () => {
  // Dev reset: re-lock resume + clear rewards flags
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(DL_FLAG_KEY);
  localStorage.removeItem(REWARDS_KEY);
  setDownloadEnabled(false);     // <-- keeps resume masked
  renderJourneyUI();
  showToast('Reset complete', 'Recruiter gate is locked again.');
});

byId('trophy-fab')?.addEventListener('click', () => openTrophyDrawer());
byId('trophy-close')?.addEventListener('click', () => closeTrophyDrawer());

// Clicking the toast closes it
byId('reward-toast')?.addEventListener('click', () => {
  const t = byId('reward-toast');
  if (t) t.style.display = 'none';
});

// ===========================
// Resume Gate UI wiring (FIX)
// ===========================
function wireResumeGateUI() {
  const unlockBtn = byId('resume-unlock-btn');
  const overlay = byId('resume-mask-overlay');
  const modal = byId('resume-gate-modal');

  // Hard guard so the module doesn't silently fail
  if (!unlockBtn || !overlay || !modal) {
    console.error('[ResumeGate] Missing required elements:', {
      unlockBtn: !!unlockBtn,
      overlay: !!overlay,
      modal: !!modal,
    });
    return;
  }

  // Ensure initial locked/unlocked state is applied on load
  setDownloadEnabled(isUnlocked());

  // Open modal from either button or overlay
  unlockBtn.addEventListener('click', (e) => {
    e.preventDefault();
    openGateModal();
  });

  overlay.addEventListener('click', (e) => {
    e.preventDefault();
    openGateModal();
  });

  // Also allow keyboard open from overlay
  overlay.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      openGateModal();
    }
  });
}

// Run after DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', wireResumeGateUI);
} else {
  wireResumeGateUI();
}

</script>
<!-- End [JS-4] Recruiter Gate -->